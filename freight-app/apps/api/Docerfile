# Stage 1: build
FROM node:18-alpine AS builder
WORKDIR /usr/src/app

# copy package files first for caching
COPY package*.json ./
# if monorepo with root package.json, adjust path or copy root package.json
RUN npm ci

# copy rest of app
COPY . .
RUN npm run build
RUN npx prisma generate

# Stage 2: production image
FROM node:18-alpine
WORKDIR /usr/src/app
ENV NODE_ENV=production

COPY --from=builder /usr/src/app/dist ./dist
COPY --from=builder /usr/src/app/package*.json ./

RUN npm ci --production

# expose port used by app
ENV PORT=3001
EXPOSE 3001

CMD ["node", "dist/main.js"]
